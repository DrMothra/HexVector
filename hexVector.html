<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
	<title>Phaser - Making your first game, part 3</title>
    <script src="js/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var game = new Phaser.Game(800, 600, Phaser.AUTO, '', { preload: preload, create: create });

function preload() {

    game.load.image('vector', 'assets/vectorHex.png');

    game.load.audio('explosion', 'assets/audio/explosion.mp3');
    game.load.audio('sword', 'assets/audio/sword.mp3');
    game.load.audio('blaster', 'assets/audio/blaster.mp3');
    game.load.audio('ping', 'assets/audio/p-ping.mp3');

}

var line, result;
var musicSquare, musicGroup;
var shapes = [
    {x: 250, y: 110, width: 150, height: 150}
];
var shapeCentres = [
    {x: 325, y: 110},
    {x: 400, y: 185},
    {x: 325, y: 260},
    {x: 250, y: 185}
];
var notes = ['explosion', 'sword', 'blaster', 'ping'];
var fx = [];

function create() {

    var graphics = game.add.graphics(0, 0);

    // set a fill and line style
    graphics.beginFill(0xFF3300);
    graphics.lineStyle(10, 0xffffff, 1);

    graphics.moveTo(0, 400);
    graphics.lineTo(800,400);
    graphics.endFill();

    musicGroup = game.add.group();

    musicSquare = game.add.graphics(0, 0);
    musicSquare.beginFill(0x000000);
    musicSquare.lineStyle(10, 0x868686, 1);
    musicSquare.drawRect(250, 110, 150, 150);
    musicSquare.endFill();
    musicGroup.add(musicSquare);
    musicGroup.getBounds();


    line = game.add.sprite(32, game.world.height - 150, 'vector');
    line.scale.setTo(0.5, 0.25);

    //  Enable input and allow for dragging
    line.inputEnabled = true;
    line.input.enableDrag();
    line.events.onDragStop.add(onDragStop, this);

    for(var i=0; i<notes.length; ++i) {
        fx.push(game.add.audio(notes[i]));
    }

    //  Being mp3 files these take time to decode, so we can't play them instantly
    //  Using setDecodedCallback we can be notified when they're ALL ready for use.
    //  The audio files could decode in ANY order, we can never be sure which it'll be.

    //game.sound.setDecodedCallback(fx, start, this);
}

function onDragStop(sprite, pointer) {

    var lineBounds = line.getBounds();
    var rectBounds = musicGroup.getBounds();

    if(Phaser.Rectangle.intersects(lineBounds, rectBounds)) {
        snapToLine(pointer);
    }

}

function snapToLine(pointer) {

    var minDist = 1000000, centrePoint = undefined;
    var tempDist;
    var tempPoint = new Phaser.Point();
    for(var i=0; i<shapeCentres.length; ++i) {
        tempPoint.setTo(shapeCentres[i].x, shapeCentres[i].y);
        tempDist = Phaser.Point.distance(pointer, tempPoint);
        if(tempDist < minDist) {
            minDist = tempDist;
            centrePoint = i;
        }
    }

    //DEBUG
    //console.log("Centre point = ", centrePoint);

    if(centrePoint != undefined) {
        line.rotation = 0;
        if(centrePoint % 2 === 0 ) {
            line.rotation = 3.14159/2;
            line.x = shapeCentres[centrePoint].x+60;
            line.y = shapeCentres[centrePoint].y-10;
        } else {
            line.x = shapeCentres[centrePoint].x-10;
            line.y = shapeCentres[centrePoint].y-60;
        }
        fx[centrePoint].play();
    }
}

function checkOverlap(sprite) {
    var bounds = sprite.getBounds();
    var boundsB = musicGroup.getBounds();

    return Phaser.Rectangle.intersects(bounds, boundsB);
}


</script>

</body>
</html>